Тут весь исходный код моего бота.
Я разделяю всех пользователей на 4 группы
 - незарегистрированный пользователь
 - зарегистрированный пользователь без ключа
 - зарегистрированный пользователь с ключом
 - зарегистрированный пользователь с просроченным ключом

А так же пользователь может быть АДМИНОМ. Но он может не числится в БД. У админа просто будет снизу
клавиатуры кнопка "Админ панель", через которую он может делать что угодно.

## Файлы

### `start_bot.py`

Запуск бота происходит через этот файл. 
В этом файле импортируются все блупринты бота. Импортируется фикс для vkbottle, конфиги из папки
config. А в папке config(`__init__.py`) есть объекты для связи с Redis и ещё вспомогательные
структуры, которые используются в боте.

Так же в этом файле есть middleware'и `UserRecognize` для распознавания пользователя и `AntiSpam`,
для контроля нагрузки на бота.

В `UserRecognize` берется информация из БД и записывается в Redis на 5 минут для кеша.
В `AntiSpam` тоже используется Redis. Каждое сообщение записывается в Redis как 
`r.incr("{user_id}_spam")`, и ставится таймер на 2 секунды. Если `{user_id}_spam` больше 2 то 
сообщение не проходит дальше.

Ещё в этом файле есть `on_user_block` эвент, который удаляет ключ пользователя из БД, если админ
заблокировал пользователя в группе ВК.

Так же в этом файле инициализируется сервер для прослушки сообщений из QIWI API, чтобы бот смог 
принимать платежи и добавлять пользователя в БД как "купившего ключ".
И ещё инициализируется asyncio task для контроля ключей в БД. Если ключ истекает, то бот сообщает
пользователю, что ключ истекает. А если ключ истек то и вовсе удаляет его из `Reids db 0`. Ну и 
следит за тем, чтобы все купленные ключи были в `Redis db 0`.

### `key_controller.py`

Как говорилось в пункте `start_bot.py` это asyncio task для контроля ключей в `Redis db 0`.
Что за `Redis db 0`? Это кеш уже для другого моего приложения на Flask. Мой бот активно общается с 
этим приложением через Redis...

### `user_key_control.py`

В этом файле есть вся логика панельки "Управления ключом пользователя". Имею в виду не всех 
пользователей, а только одного пользователя, владельца ключа.
Там используется Blueprint со своими auto_rule'ами. Blueprint'ы используются в проекте часто

### `menu.py`

Это файл с Blueprint'ом менюхи бота. Там есть хендлеры кнопок "Информация" и "Прайслист". 

### `registration.py`

В этом файле расположена логика регистрации пользователя через Steam. Мне SteamID нужен чисто
для понимания, кем является пользователь. В этом файле импортируется интересный файл - 
`utils/steam_auth.py`, `steam_auth.py` поднимает сервер на aiohttp и принимает запросы со серверов 
Steam. Прочтите про Steam OpenID в интернете, чтобы понять как работает `steam_auth.py`.
В `registartion.py` используются Callback кнопки, для выдачи ссылки для авторизации в Steam.

### `purchase.py`

Довольно массивный код с логикой покупки ключа у бота. Там используются StatePeer'ы, чтобы юзер 
с легкостью мог выбрать что ему надо, прописать промокод на скидку к тарифу, и купить в конце 
концов. Используется `utils/qiwi_purchase.py` чтобы выдать ссылку на покупку тарифа.

## Папки

### admin
В этой папке расположена вся логика админ панели в боте

### config
В этой папке расположены файлы конфигурации, я использую json, для того, чтобы изменять какие-то 
параметры бота не перезагружая бота. Например, добавить новый промокод в `promocode.json` или
админа в `admin.json`, или даже изменить токены QIWI и другую хрень в кфг. Так же там есть 
`info.txt`. Там написан текст кнопки "Информация".

### keyboard 
А тут есть код всех клавиатур бота. Там так же есть генераторы клавиатур, чтобы дать пользователю
клавиатуру под его группу. 

### utils

В этой папке есть код, который используется в проекте повсеместно. Например, `orm.py`, чтобы делать
запросы в БД. Или правила, которых нет в vkbottle почему-то :)

---

Подробную информацию можно найти в выше перечисленных папках.

Читайте код :)